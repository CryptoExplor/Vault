<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Notes & Passwords - Updated</title>
    
    <!-- Third-party libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/lib/marked.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.12.1/dist/ethers.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease;
            background-color: #f3f4f6;
        }
        .dark body {
            background-color: #111827;
            color: #e5e7eb;
        }
        .note-card, .password-card {
            cursor: grab;
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .note-card:active, .password-card:active {
            cursor: grabbing;
        }
        .prose a {
            color: #3b82f6;
        }
        .prose h1, .prose h2, .prose h3 {
            font-weight: bold;
        }
        .ghost {
            opacity: 0.5;
        }
        .sortable-chosen {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: rotate(2deg) scale(1.05);
        }
        .pinned-note {
            border-left-color: #f59e0b;
            border-left-width: 6px;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen p-4">

<!-- Lock Screen -->
<div id="lock-screen" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl text-center w-full max-w-sm mx-4">
        <h1 class="text-3xl font-bold mb-4">Locked</h1>
        <p class="text-gray-500 dark:text-gray-400 mb-6">Unlock to access your secure notes and passwords.</p>
        
        <div id="set-password-screen" class="space-y-4">
            <h2 class="text-xl font-semibold text-purple-600 dark:text-purple-400">Set Master Password</h2>
            <p class="text-sm text-gray-400">This password will be used to encrypt all your data locally.</p>
            <input type="password" id="set-password-input" placeholder="Enter master password" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <button onclick="setMasterPassword()" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors">Set Password</button>
        </div>

        <div id="auth-password-screen" class="hidden space-y-4">
            <h2 class="text-xl font-semibold text-purple-600 dark:text-purple-400">Enter Master Password</h2>
            <input type="password" id="auth-password-input" placeholder="Enter master password" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <button onclick="authenticateMasterPassword()" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors">Unlock</button>
        </div>
        
        <div class="my-6 text-gray-500 dark:text-gray-400 flex items-center justify-center">
            <span class="flex-grow border-t border-gray-300 dark:border-gray-600"></span>
            <span class="mx-4 text-sm">OR</span>
            <span class="flex-grow border-t border-gray-300 dark:border-gray-600"></span>
        </div>
        
        <button id="connect-wallet-btn" onclick="connectWallet()" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors"><i class="fas fa-wallet mr-2"></i>Connect Wallet</button>
        <div id="wallet-status" class="mt-4 text-sm text-gray-500 dark:text-gray-400">Wallet not connected.</div>
    </div>
</div>

<!-- Main App Container -->
<div id="main-app" class="hidden max-w-4xl mx-auto py-8">
    <header class="text-center mb-10">
        <h1 class="text-4xl font-extrabold text-purple-600 dark:text-purple-400 mb-2">Secure Manager</h1>
        <p class="text-gray-500 dark:text-gray-400">Your notes and passwords, encrypted for security (local only).</p>
        <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-2">
            <label for="lock-timer-input" class="text-sm">Auto-lock after (min):</label>
            <input type="number" id="lock-timer-input" value="5" min="1" class="w-20 px-2 py-1 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">
            <button onclick="lockApp()" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors">Lock Now</button>
        </div>
    </header>

    <!-- Tabs for Notes and Passwords -->
    <div class="flex justify-center mb-6 border-b border-gray-200 dark:border-gray-700">
        <button id="notes-tab-btn" onclick="showTab('notes-tab')" class="tab-button px-6 py-3 font-semibold transition-colors border-b-2 border-purple-500 text-purple-600 dark:text-purple-400">Notes</button>
        <button id="passwords-tab-btn" onclick="showTab('passwords-tab')" class="tab-button px-6 py-3 font-semibold transition-colors text-gray-500 dark:text-gray-400 hover:text-purple-600 hover:dark:text-purple-400">Passwords</button>
    </div>

    <!-- Notes Tab Content -->
    <div id="notes-tab" class="">
        <!-- Note Input Section -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl mb-8" id="add-note-form">
            <h2 class="text-2xl font-bold mb-4 text-purple-600 dark:text-purple-400">Add New Note</h2>
            <input type="text" id="new-note-title" placeholder="Note Title" class="w-full px-4 py-3 mb-4 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <textarea id="new-note-content" placeholder="Write your note here... (supports Markdown)" rows="5" class="w-full px-4 py-3 mb-4 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
            <input type="text" id="new-note-tags" placeholder="Tags (e.g., work, ideas)" class="w-full px-4 py-3 mb-4 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <button onclick="addItem('note')" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors">Add Note</button>
        </div>

        <!-- Notes Display Section -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl">
            <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                <h2 class="text-2xl font-bold text-purple-600 dark:text-purple-400">My Notes</h2>
                <div class="flex space-x-2 flex-wrap justify-end gap-2">
                    <select id="notes-filter-tags" onchange="selectedTags = this.value ? [this.value] : []; updateDisplay(document.getElementById('notes-search-input').value);" class="px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-sm">
                        <option value="">All Tags</option>
                    </select>
                    <input type="text" id="notes-search-input" onkeyup="clearTimeout(searchTimeout); searchTimeout = setTimeout(() => updateDisplay(this.value), 300);" placeholder="Search notes..." class="px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    <button id="export-notes" class="px-4 py-2 text-sm bg-purple-500 hover:bg-purple-600 text-white rounded-full transition-colors">
                      <i class="fas fa-file-export"></i> Export
                    </button>
                    <label class="cursor-pointer px-4 py-2 text-sm bg-indigo-500 hover:bg-indigo-600 text-white rounded-full transition-colors">
                      <i class="fas fa-file-import"></i> Import
                      <input type="file" id="import-notes-file" accept=".json" class="hidden">
                    </label>
                </div>
            </div>
            <div id="notes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sortable-container">
                <!-- Notes will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Passwords Tab Content -->
    <div id="passwords-tab" class="hidden">
        <!-- Password Input Section -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl mb-8" id="add-password-form">
            <h2 class="text-2xl font-bold mb-4 text-purple-600 dark:text-purple-400">Add New Password</h2>
            <input type="text" id="new-password-title" placeholder="Website/Service Name" class="w-full px-4 py-3 mb-4 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <input type="text" id="new-password-username" placeholder="Username/Email" class="w-full px-4 py-3 mb-4 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <div class="flex items-center space-x-2 mb-4">
                <input type="text" id="new-password-password" placeholder="Password" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button onclick="generatePassword()" class="px-4 py-3 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors whitespace-nowrap">Generate</button>
            </div>
            <input type="text" id="new-password-tags" placeholder="Tags (e.g., social, work)" class="w-full px-4 py-3 mb-4 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <button onclick="addItem('password')" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors">Add Password</button>
        </div>

        <!-- Passwords Display Section -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl">
            <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                <h2 class="text-2xl font-bold text-purple-600 dark:text-purple-400">My Passwords</h2>
                <div class="flex space-x-2">
                    <select id="passwords-filter-tags" onchange="selectedTags = this.value ? [this.value] : []; updateDisplay(document.getElementById('passwords-search-input').value);" class="px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-sm">
                        <option value="">All Tags</option>
                    </select>
                    <input type="text" id="passwords-search-input" onkeyup="clearTimeout(searchTimeout); searchTimeout = setTimeout(() => updateDisplay(this.value), 300);" placeholder="Search passwords..." class="px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    <button id="export-passwords" class="px-4 py-2 text-sm bg-purple-500 hover:bg-purple-600 text-white rounded-full transition-colors">
                      <i class="fas fa-file-export"></i> Export
                    </button>
                    <label class="cursor-pointer px-4 py-2 text-sm bg-indigo-500 hover:bg-indigo-600 text-white rounded-full transition-colors">
                      <i class="fas fa-file-import"></i> Import
                      <input type="file" id="import-passwords-file" accept=".json" class="hidden">
                    </label>
                </div>
            </div>
            <div id="passwords-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sortable-container">
                <!-- Passwords will be dynamically inserted here -->
            </div>
        </div>
    </div>
</div>

<!-- Toast/Alert component -->
<div id="toast" class="toast fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-transform transform translate-y-20">
    <span id="toast-message"></span>
</div>

<!-- Confirmation Modal -->
<div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl text-center w-96">
        <h3 class="text-xl font-bold mb-4">Confirmation</h3>
        <p id="modal-message" class="text-gray-700 dark:text-gray-300 mb-6"></p>
        <div class="flex justify-around">
            <button id="confirm-button" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Yes</button>
            <button id="cancel-button" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">No</button>
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div id="edit-item-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-2xl">
        <h2 class="text-2xl font-bold mb-4 text-purple-600 dark:text-purple-400">Edit Item</h2>
        
        <!-- Note Fields -->
        <div id="edit-note-fields" class="space-y-4">
            <input type="text" id="edit-title" placeholder="Note Title" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <textarea id="edit-content" placeholder="Write your note here... (supports Markdown)" rows="10" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
            <input type="text" id="edit-tags" placeholder="Tags (e.g., work, ideas)" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
        </div>
        
        <!-- Password Fields -->
        <div id="edit-password-fields" class="hidden space-y-4">
            <input type="text" id="edit-password-title" placeholder="Website/Service Name" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <input type="text" id="edit-password-username" placeholder="Username/Email" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <input type="text" id="edit-password-password" placeholder="Password" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <input type="text" id="edit-password-tags" placeholder="Tags (e.g., social, work)" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
        </div>
        
        <div class="flex justify-end space-x-4 mt-4">
            <button onclick="document.getElementById('edit-item-modal').classList.add('hidden')" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancel</button>
            <button id="save-edit-btn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save Changes</button>
        </div>
    </div>
</div>

<!-- History Modal -->
<div id="history-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-xl">
        <h2 class="text-2xl font-bold mb-4 text-purple-600 dark:text-purple-400">Version History</h2>
        <ul id="history-list" class="space-y-4"></ul>
        <div class="flex justify-end mt-4">
            <button onclick="document.getElementById('history-modal').classList.add('hidden')" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Close</button>
        </div>
    </div>
</div>

<div class="absolute top-4 right-4 p-2 text-sm text-gray-500 dark:text-gray-400">
    <span id="theme-toggle" class="cursor-pointer">
        <i class="fas fa-sun hidden dark-icon"></i>
        <i class="fas fa-moon light-icon"></i>
    </span>
</div>

<footer class="text-center mt-10 py-4 text-gray-400 dark:text-gray-600 text-sm">
    <p>Made with <span class="text-red-500">&hearts;</span> by CryptoExplor</p>
    <p><a href="https://github.com/CryptoExplor" target="_blank" class="hover:underline">github.com/CryptoExplor</a></p>
</footer>

<script>
    // Global Constants & State
    const THEME_KEY = 'theme_preference';
    const APP_DATA_KEY = 'app_data';
    let walletAddress = null;
    let masterKey = null; // CryptoKey stored while unlocked
    let isLocked = true;
    let allTags = new Set();
    let selectedTags = [];
    let searchTimeout;
    let lockTimeout;

    // Helper: base64 / buffer conversions
    function buf2b64(buf) {
        return btoa(String.fromCharCode(...new Uint8Array(buf)));
    }
    function b642buf(b64) {
        const bin = atob(b64);
        const len = bin.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = bin.charCodeAt(i);
        return bytes.buffer;
    }
    function str2ab(str) {
        return new TextEncoder().encode(str);
    }
    function ab2str(ab) {
        return new TextDecoder().decode(ab);
    }

    // --- Crypto using Web Crypto API (AES-GCM + PBKDF2) ---
    async function deriveCryptoKey(passphrase, providedSaltB64 = null) {
        // returns {key: CryptoKey, saltB64}
        const salt = providedSaltB64 ? b642buf(providedSaltB64) : crypto.getRandomValues(new Uint8Array(16));
        const baseKey = await crypto.subtle.importKey(
            'raw',
            str2ab(passphrase),
            { name: 'PBKDF2' },
            false,
            ['deriveKey']
        );
        const key = await crypto.subtle.deriveKey(
            { name: 'PBKDF2', salt: salt, iterations: 200000, hash: 'SHA-256' },
            baseKey,
            { name: 'AES-GCM', length: 256 },
            false,
            ['encrypt', 'decrypt']
        );
        return { key, saltB64: buf2b64(salt) };
    }

    async function encryptText(plaintext) {
        if (!masterKey) return null;
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encrypted = await crypto.subtle.encrypt(
            { name: 'AES-GCM', iv },
            masterKey,
            str2ab(plaintext)
        );
        return {
            ciphertext: buf2b64(encrypted),
            iv: buf2b64(iv.buffer),
            salt: localStorage.getItem('encryption_salt')
        };
    }

    async function decryptText(encryptedObj) {
        if (!masterKey) return '';
        if (!encryptedObj || !encryptedObj.ciphertext) return '';
        try {
            const ct = b642buf(encryptedObj.ciphertext);
            const iv = b642buf(encryptedObj.iv);
            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: new Uint8Array(iv) },
                masterKey,
                ct
            );
            return ab2str(decrypted);
        } catch (e) {
            console.error('Decryption failed', e);
            return '';
        }
    }

    // --- UI Helpers ---
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;
        toast.className = 'toast fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-transform transform translate-y-20';
        if (type === 'success') toast.classList.add('bg-green-500', 'text-white');
        else if (type === 'error') toast.classList.add('bg-red-500', 'text-white');
        else toast.classList.add('bg-gray-800', 'text-white');
        setTimeout(() => toast.classList.add('translate-y-0'), 10);
        setTimeout(() => { toast.classList.remove('translate-y-0'); setTimeout(() => { toast.className = 'toast fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-transform transform translate-y-20'; }, 500); }, 3000);
    }

    function showModal(message, onConfirm) {
        const modal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const confirmButton = document.getElementById('confirm-button');
        const cancelButton = document.getElementById('cancel-button');
        modalMessage.textContent = message;
        modal.classList.remove('hidden');
        confirmButton.onclick = () => { modal.classList.add('hidden'); onConfirm(true); };
        cancelButton.onclick = () => { modal.classList.add('hidden'); onConfirm(false); };
    }

    // --- Master Password Management ---
    async function setMasterPassword() {
        const password = document.getElementById('set-password-input').value;
        if (!password) { showToast('Password cannot be empty.', 'error'); return; }
        const { key, saltB64 } = await deriveCryptoKey(password);
        masterKey = key;
        localStorage.setItem('encryption_salt', saltB64);
        localStorage.setItem('master_password_set', 'true');
        document.getElementById('set-password-input').value = '';
        unlockApp();
        showToast('Master password set and app unlocked.', 'success');
    }

    async function authenticateMasterPassword() {
        const password = document.getElementById('auth-password-input').value;
        if (!password) { showToast('Password cannot be empty.', 'error'); return; }
        const saltB64 = localStorage.getItem('encryption_salt');
        if (!saltB64) { showToast('No salt found. Set master password first.', 'error'); return; }
        const { key } = await deriveCryptoKey(password, saltB64);
        // Try decrypting first record as test
        const appData = JSON.parse(localStorage.getItem(APP_DATA_KEY) || '[]');
        if (appData.length === 0) {
            masterKey = key; // no data, accept
            unlockApp();
            document.getElementById('auth-password-input').value = '';
            showToast('Unlocked.', 'success');
            return;
        }
        const testItem = appData.find(i => i.content);
        if (!testItem) { masterKey = key; unlockApp(); showToast('Unlocked.', 'success'); return; }
        // attempt decrypt
        masterKey = key;
        const plain = await decryptText(testItem.content);
        if (plain !== '') {
            unlockApp();
            document.getElementById('auth-password-input').value = '';
            showToast('Unlocked.', 'success');
        } else {
            masterKey = null;
            showToast('Incorrect password.', 'error');
        }
    }

    // Wallet Connection Logic
    window.connectWallet = async () => {
        if (typeof window.ethereum === 'undefined') { showToast('MetaMask is not installed. Please install it to use this feature.', 'error'); return; }
        try {
            const provider = new ethers.BrowserProvider(window.ethereum);
            await provider.send('eth_requestAccounts', []);
            const signer = await provider.getSigner();
            walletAddress = await signer.getAddress();
            // Use wallet address as a passphrase to derive key. If salt exists, reuse it so decryption remains consistent.
            const existingSalt = localStorage.getItem('encryption_salt');
            const { key, saltB64 } = await deriveCryptoKey(walletAddress, existingSalt || null);
            masterKey = key;
            if (!existingSalt) localStorage.setItem('encryption_salt', saltB64);
            document.getElementById('wallet-status').textContent = `Wallet Connected: ${walletAddress.substring(0,6)}...${walletAddress.slice(-4)}`;
            document.getElementById('connect-wallet-btn').classList.add('hidden');
            unlockApp();
            showToast('Wallet connected successfully!', 'success');
        } catch (error) {
            console.error(error);
            showToast('Failed to connect wallet.', 'error');
        }
    };

    // --- App Lock/Unlock ---
    function lockApp() {
        isLocked = true;
        document.getElementById('lock-screen').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
        masterKey = null;
        walletAddress = null;
        document.getElementById('wallet-status').textContent = 'Wallet not connected.';
        document.getElementById('connect-wallet-btn').classList.remove('hidden');
    }

    function unlockApp() {
        isLocked = false;
        document.getElementById('lock-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        updateAllTags();
        updateDisplay();
        resetLockTimer();
    }

    function resetLockTimer() {
        const lockTime = parseInt(document.getElementById('lock-timer-input').value, 10) * 60 * 1000;
        clearTimeout(lockTimeout);
        if (lockTime > 0) {
            lockTimeout = setTimeout(() => { lockApp(); showToast('App locked due to inactivity.', 'info'); }, lockTime);
        }
    }
    document.addEventListener('mousemove', () => { if (!isLocked) resetLockTimer(); });
    document.addEventListener('keydown', () => { if (!isLocked) resetLockTimer(); });

    // --- Data storage helpers ---
    function getAppData() { return JSON.parse(localStorage.getItem(APP_DATA_KEY) || '[]'); }
    function saveAppData(data) { localStorage.setItem(APP_DATA_KEY, JSON.stringify(data)); }

    // --- Rendering ---
    async function updateDisplay(searchTerm = '') {
        const notesContainer = document.getElementById('notes-container');
        const passwordsContainer = document.getElementById('passwords-container');
        const appData = getAppData();
        notesContainer.innerHTML = '';
        passwordsContainer.innerHTML = '';
        updateAllTags();

        const decryptedData = await Promise.all(appData.map(async item => {
            if (!masterKey) return item; // if locked, leave encrypted
            if (item.type === 'note') {
                const content = await decryptText(item.content);
                if (content === '') return { ...item, type: 'failed_decryption' };
                return { ...item, content };
            } else if (item.type === 'password') {
                const password = await decryptText(item.content);
                if (password === '') return { ...item, type: 'failed_decryption' };
                return { ...item, password };
            }
            return item;
        }));

        const filteredData = decryptedData.filter(item => item.type !== 'failed_decryption').filter(item => {
            const matchesSearch = searchTerm === '' || (item.title && item.title.toLowerCase().includes(searchTerm.toLowerCase())) || (item.content && item.content.toLowerCase().includes(searchTerm.toLowerCase())) || (item.username && item.username.toLowerCase().includes(searchTerm.toLowerCase())) || (item.password && item.password.toLowerCase().includes(searchTerm.toLowerCase()));
            const matchesTags = selectedTags.length === 0 || (item.tags && selectedTags.every(tag => item.tags.includes(tag)));
            return matchesSearch && matchesTags;
        });

        filteredData.sort((a,b) => (b.isPinned - a.isPinned) || (new Date(b.date) - new Date(a.date)));

        let notesFound = false, passwordsFound = false;
        filteredData.forEach(item => {
            if (item.type === 'note') { renderNoteCard(item, notesContainer); notesFound = true; }
            else if (item.type === 'password') { renderPasswordCard(item, passwordsContainer); passwordsFound = true; }
        });

        if (!notesFound) notesContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">No matching notes found.</p>';
        if (!passwordsFound) passwordsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">No matching passwords found.</p>';

        setupSortable();
    }

    function renderNoteCard(note, container) {
        const noteDiv = document.createElement('div');
        noteDiv.className = 'note-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md border-l-4 border-purple-500 dark:border-purple-400 hover:shadow-lg transition-shadow duration-200 cursor-grab relative';
        if (note.isPinned) noteDiv.classList.add('pinned-note');
        const title = document.createElement('h3'); title.className = 'text-xl font-bold mb-2 text-gray-900 dark:text-white'; title.textContent = note.title;
        const tags = document.createElement('div'); tags.className = 'flex flex-wrap gap-1 mb-2'; (note.tags||[]).forEach(tag => { tags.innerHTML += `<span class="bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xs font-semibold px-2.5 py-0.5 rounded-full">${tag}</span>`; });
        const content = document.createElement('div'); content.className = 'text-gray-700 dark:text-gray-300 mb-4 break-words prose prose-sm dark:prose-invert max-w-none'; content.innerHTML = marked.parse(note.content || '');
        const footer = document.createElement('div'); footer.className = 'flex justify-between items-center text-sm text-gray-500 dark:text-gray-400'; footer.innerHTML = `<span>${note.date}</span><div class="space-x-2"><button onclick="togglePin('${note.id}')" class="text-gray-500 hover:text-yellow-500 transition-colors ${note.isPinned ? 'text-yellow-500' : ''}"><i class="fas fa-thumbtack"></i></button><button onclick="editItem('${note.id}')" class="text-blue-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"><i class="fas fa-edit"></i></button><button onclick="deleteItem('${note.id}')" class="text-red-500 hover:text-red-600 dark:hover:text-red-400 transition-colors"><i class="fas fa-trash-alt"></i></button><button onclick="exportItemAsMarkdown('${note.id}')" class="text-gray-500 hover:text-purple-500 transition-colors"><i class="fas fa-file-export"></i></button><button onclick="showVersionHistory('${note.id}')" class="text-gray-500 hover:text-gray-600 transition-colors"><i class="fas fa-history"></i></button></div>`;
        noteDiv.appendChild(title); noteDiv.appendChild(tags); noteDiv.appendChild(content); noteDiv.appendChild(footer); container.appendChild(noteDiv);
    }

    function renderPasswordCard(password, container) {
        const passwordDiv = document.createElement('div');
        passwordDiv.className = 'password-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md border-l-4 border-blue-500 dark:border-blue-400 hover:shadow-lg transition-shadow duration-200 cursor-grab relative';
        const title = document.createElement('h3'); title.className = 'text-xl font-bold mb-2 text-gray-900 dark:text-white';
        title.textContent = password.title; const tags = document.createElement('div'); tags.className = 'flex flex-wrap gap-1 mb-2'; (password.tags||[]).forEach(tag => {
        tags.innerHTML += `<span class="bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xs font-semibold px-2.5 py-0.5 rounded-full">${tag}</span>`;});        const details = document.createElement('div');
    details.className = 'text-gray-700 dark:text-gray-300 mb-4 break-words';
    details.innerHTML = `<p><span class="font-semibold">Username:</span> ${password.username || ''}</p>`;

    const pwRow = document.createElement('div');
    pwRow.className = 'flex items-center space-x-2 mt-2';
    pwRow.innerHTML = `<span class="font-semibold">Password:</span>`;

    const pwInput = document.createElement('input');
    pwInput.type = 'password';
    pwInput.value = password.password || '';
    pwInput.readOnly = true;

    // Tailwind classes + explicit style fallback for non-Tailwind
        pwInput.className = 'bg-transparent border-none text-gray-700 dark:text-gray-300 flex-grow min-w-0 truncate focus:outline-none';
        pwInput.id = `password-${password.id}`;

    // ensure minWidth is enforced even if Tailwind class isn't available
        pwInput.style.minWidth = '0';
        pwInput.style.maxWidth = '100%';
        pwInput.style.boxSizing = 'border-box';

    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'text-gray-500 hover:text-gray-600 transition-colors';
    toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
    toggleBtn.onclick = () => {
        if (pwInput.type === 'password') {
            pwInput.type = 'text';
            toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
        } else {
            pwInput.type = 'password';
            toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
        }
    };

    const copyBtn = document.createElement('button');
    copyBtn.className = 'text-gray-500 hover:text-purple-500 transition-colors';
    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
    copyBtn.onclick = async () => {
        try {
            await navigator.clipboard.writeText(pwInput.value);
            showToast('Copied to clipboard!', 'success');
        } catch (e) {
            showToast('Copy failed', 'error');
        }
    };

    pwRow.appendChild(pwInput);
    pwRow.appendChild(toggleBtn);
    pwRow.appendChild(copyBtn);
    details.appendChild(pwRow);

    const footer = document.createElement('div');
    footer.className = 'flex justify-end items-center text-sm text-gray-500 dark:text-gray-400 mt-4';
    footer.innerHTML = `<div class="space-x-2"><button onclick="editItem('${password.id}')" class="text-blue-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"><i class="fas fa-edit"></i></button><button onclick="deleteItem('${password.id}')" class="text-red-500 hover:text-red-600 dark:hover:text-red-400 transition-colors"><i class="fas fa-trash-alt"></i></button></div>`;

    passwordDiv.appendChild(title);
    passwordDiv.appendChild(tags);
    passwordDiv.appendChild(details);
    passwordDiv.appendChild(footer);
    container.appendChild(passwordDiv);
}


    // --- Note & Password Management ---
    window.addItem = async (type) => {
        if (!masterKey) { showToast('Please unlock the app first.', 'error'); return; }
        const appData = getAppData();
        const newItem = { id: crypto.randomUUID(), type, tags: [], date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }), history: [] };
        if (type === 'note') {
            const title = document.getElementById('new-note-title').value.trim();
            const content = document.getElementById('new-note-content').value.trim();
            const tags = document.getElementById('new-note-tags').value.split(',').map(t => t.trim()).filter(t=>t);
            if (!title || !content) { showToast('Title and content cannot be empty.', 'error'); return; }
            newItem.title = title;
            newItem.content = await encryptText(content);
            newItem.tags = tags;
            newItem.isPinned = false;
            // clear inputs
            document.getElementById('new-note-title').value = '';
            document.getElementById('new-note-content').value = '';
            document.getElementById('new-note-tags').value = '';
        } else if (type === 'password') {
            const title = document.getElementById('new-password-title').value.trim();
            const username = document.getElementById('new-password-username').value.trim();
            const password = document.getElementById('new-password-password').value;
            const tags = document.getElementById('new-password-tags').value.split(',').map(t=>t.trim()).filter(t=>t);
            if (!title || !username || !password) { showToast('All password fields must be filled.', 'error'); return; }
            newItem.title = title; newItem.username = username; newItem.content = await encryptText(password); newItem.tags = tags;
            document.getElementById('new-password-title').value = '';
            document.getElementById('new-password-username').value = '';
            document.getElementById('new-password-password').value = '';
            document.getElementById('new-password-tags').value = '';
        }
        appData.unshift(newItem);
        saveAppData(appData);
        updateDisplay();
        showToast(`${type.charAt(0).toUpperCase()+type.slice(1)} added!`, 'success');
    };

    window.editItem = async (id) => {
        const appData = getAppData();
        const item = appData.find(i => i.id === id);
        if (!item) return;
        if (item.type === 'note') {
            const content = await decryptText(item.content);
            document.getElementById('edit-title').value = item.title;
            document.getElementById('edit-content').value = content;
            document.getElementById('edit-tags').value = (item.tags||[]).join(', ');
            document.getElementById('edit-password-fields').classList.add('hidden');
            document.getElementById('edit-note-fields').classList.remove('hidden');
        } else if (item.type === 'password') {
            const password = await decryptText(item.content);
            document.getElementById('edit-password-title').value = item.title;
            document.getElementById('edit-password-username').value = item.username;
            document.getElementById('edit-password-password').value = password;
            document.getElementById('edit-password-tags').value = (item.tags||[]).join(', ');
            document.getElementById('edit-note-fields').classList.add('hidden');
            document.getElementById('edit-password-fields').classList.remove('hidden');
        }
        document.getElementById('edit-item-modal').classList.remove('hidden');
        document.getElementById('save-edit-btn').onclick = async () => {
            if (item.type === 'note') {
                const newTitle = document.getElementById('edit-title').value.trim();
                const newContent = document.getElementById('edit-content').value.trim();
                const newTags = document.getElementById('edit-tags').value.split(',').map(t=>t.trim()).filter(t=>t);
                if (newContent !== await decryptText(item.content)) { item.history.unshift({ content: item.content, date: new Date().toISOString() }); if (item.history.length > 5) item.history.pop(); }
                item.content = await encryptText(newContent);
                item.title = newTitle; item.tags = newTags;
            } else if (item.type === 'password') {
                const newTitle = document.getElementById('edit-password-title').value.trim();
                const newUsername = document.getElementById('edit-password-username').value.trim();
                const newPassword = document.getElementById('edit-password-password').value;
                const newTags = document.getElementById('edit-password-tags').value.split(',').map(t=>t.trim()).filter(t=>t);
                item.title = newTitle; item.username = newUsername; item.content = await encryptText(newPassword); item.tags = newTags;
            }
            saveAppData(appData);
            updateDisplay();
            document.getElementById('edit-item-modal').classList.add('hidden');
            showToast('Item updated!', 'success');
        };
    };

    window.deleteItem = (id) => {
        showModal('Are you sure you want to delete this item?', (confirmed) => {
            if (confirmed) { const data = getAppData().filter(i => i.id !== id); saveAppData(data); updateDisplay(); showToast('Item deleted!', 'success'); }
        });
    };

    window.togglePin = (id) => { const data = getAppData(); const item = data.find(i=>i.id===id); if (!item) return; item.isPinned = !item.isPinned; saveAppData(data); updateDisplay(); };

    window.exportItemAsMarkdown = async (id) => {
        if (!masterKey) { showToast('Please unlock the app first.', 'error'); return; }
        const appData = getAppData(); const note = appData.find(n=>n.id===id && n.type==='note'); if (!note) { showToast('Note not found.', 'error'); return; }
        const content = await decryptText(note.content);
        const fileName = `${note.title.replace(/[^a-z0-9]/gi,'_').toLowerCase()}.md`;
        const blob = new Blob([`# ${note.title}\n\n${content}\n\n---\nTags: ${(note.tags||[]).join(', ')}\nDate: ${note.date}`], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('Note exported!', 'success');
    };

    window.exportAsJson = () => {
        if (!masterKey) { showToast('Please unlock the app first.', 'error'); return; }
        const appData = getAppData(); const json = JSON.stringify(appData, null, 2); const blob = new Blob([json], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'secure_manager_export.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('All data exported!', 'success');
    };

    window.importFromJson = (event) => {
        const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (!Array.isArray(importedData)) throw new Error('Invalid file format. Must be a JSON array.');
                showModal('Importing will overwrite your existing data. Are you sure?', (confirmed) => { if (confirmed) { localStorage.setItem(APP_DATA_KEY, JSON.stringify(importedData)); updateDisplay(); showToast('Data imported successfully!', 'success'); } });
            } catch (error) { showToast(`Error importing file: ${error.message}`, 'error'); }
        }; reader.readAsText(file);
    };

    window.showVersionHistory = (id) => { const note = getAppData().find(n=>n.id===id); if (!note || !note.history || note.history.length===0) { showToast('No version history for this note.', 'info'); return; } const modal = document.getElementById('history-modal'); const list = document.getElementById('history-list'); list.innerHTML = ''; note.history.forEach((version, idx) => { const li = document.createElement('li'); li.className = 'p-4 rounded-lg bg-gray-100 dark:bg-gray-700 flex justify-between items-center mb-2'; li.innerHTML = `<span class="text-sm">Version saved on ${new Date(version.date).toLocaleString()}</span><button onclick="restoreVersion('${id}', ${idx})" class="px-3 py-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors">Restore</button>`; list.appendChild(li); }); modal.classList.remove('hidden'); };

    window.restoreVersion = (noteId, versionIndex) => { const data = getAppData(); const note = data.find(n=>n.id===noteId); if (!note) return; const oldContent = note.content; const newContent = note.history[versionIndex].content; note.history.unshift({ content: oldContent, date: new Date().toISOString() }); if (note.history.length>5) note.history.pop(); note.content = newContent; saveAppData(data); updateDisplay(); document.getElementById('history-modal').classList.add('hidden'); showToast('Version restored!', 'success'); };

    window.generatePassword = () => {
        const length = 16; const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+~`|}{[]:;?><,./-="; let password=''; const randomBytes = new Uint8Array(length); crypto.getRandomValues(randomBytes); for (let i=0;i<length;i++) password += charset[randomBytes[i] % charset.length]; document.getElementById('new-password-password').value = password; };

    // Sortable
    function setupSortable() {
        const containers = document.querySelectorAll('.sortable-container');
        containers.forEach(container => {
            if (container.classList.contains('sortable-initialized')) return;
            new Sortable(container, {
                animation: 150,
                onEnd: (evt) => {
                    const appData = getAppData();
                    // naive reorder by indexes in the combined dataset; for complex apps consider storing explicit order array
                    const [moved] = appData.splice(evt.oldIndex, 1);
                    appData.splice(evt.newIndex, 0, moved);
                    saveAppData(appData);
                    updateDisplay();
                }
            });
            container.classList.add('sortable-initialized');
        });
    }

    // Tag helpers
    function updateAllTags() {
        const appData = getAppData(); allTags = new Set(); appData.forEach(item => { (item.tags||[]).forEach(t => allTags.add(t)); }); updateTagFilterDropdowns(); }
    function updateTagFilterDropdowns() {
        const notesDropdown = document.getElementById('notes-filter-tags'); const passwordsDropdown = document.getElementById('passwords-filter-tags'); notesDropdown.innerHTML = '<option value="">All Tags</option>'; passwordsDropdown.innerHTML = '<option value="">All Tags</option>';
        allTags.forEach(tag => { const opt1 = document.createElement('option'); opt1.value = tag; opt1.textContent = tag; notesDropdown.appendChild(opt1); const opt2 = document.createElement('option'); opt2.value = tag; opt2.textContent = tag; passwordsDropdown.appendChild(opt2); });
    }

    // Theme
    function applyTheme(isDark) { const html = document.documentElement; const sunIcon = document.querySelector('.dark-icon'); const moonIcon = document.querySelector('.light-icon'); if (isDark) { html.classList.add('dark'); sunIcon.classList.remove('hidden'); moonIcon.classList.add('hidden'); } else { html.classList.remove('dark'); sunIcon.classList.add('hidden'); moonIcon.classList.remove('hidden'); } localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light'); }

    function showTab(tabId) {
        const tabs = ['notes-tab', 'passwords-tab']; tabs.forEach(tab => document.getElementById(tab).classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        const tabButtons = document.querySelectorAll('.tab-button'); tabButtons.forEach(btn => { btn.classList.remove('border-b-2','border-purple-500','text-purple-600','dark:text-purple-400'); btn.classList.add('text-gray-500','dark:text-gray-400','hover:text-purple-600','hover:dark:text-purple-400'); });
        document.getElementById(`${tabId}-btn`).classList.remove('text-gray-500','dark:text-gray-400'); document.getElementById(`${tabId}-btn`).classList.add('border-b-2','border-purple-500','text-purple-600','dark:text-purple-400');
        // update search for the active tab
        if (tabId === 'notes-tab') updateDisplay(document.getElementById('notes-search-input').value);
        else updateDisplay(document.getElementById('passwords-search-input').value);
    }

    // Init

    // Encrypted Password Export Function
    async function exportPasswords() {
        if (!masterKey) { showToast('Unlock first!', 'error'); return; }
        const appData = getAppData();
        const passwords = appData.filter(i => i.type === 'password');
        if (!passwords.length) { showToast('No passwords to export!', 'error'); return; }

        const encoder = new TextEncoder();
        const data = encoder.encode(JSON.stringify(passwords));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, masterKey, data);
        const payload = { iv: buf2b64(iv.buffer), data: buf2b64(encrypted) };

        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'passwords-encrypted.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('Passwords exported (encrypted).', 'success');
    }

    // Encrypted Password Import Function
    async function importPasswords(file) {
        if (!masterKey) { showToast('Unlock first!', 'error'); return; }
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const payload = JSON.parse(e.target.result);
                const iv = b642buf(payload.iv);
                const encrypted = b642buf(payload.data);

                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: new Uint8Array(iv) },
                    masterKey,
                    encrypted
                );
                const decoder = new TextDecoder();
                const passwords = JSON.parse(decoder.decode(decrypted));

                const existing = getAppData();
                const merged = [...existing, ...passwords];
                saveAppData(merged);
                updateDisplay();
                showToast('Passwords imported successfully!', 'success');
            } catch (err) {
                console.error(err);
                showToast('Import failed (wrong key or file)', 'error');
            }
        };
        reader.readAsText(file);
    }


    // Optional: Granular export functions
    window.exportPasswordsJson = () => {
        if (!masterKey) { showToast('Unlock first!', 'error'); return; }
        const appData = getAppData().filter(i => i.type === 'password');
        const json = JSON.stringify(appData, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'passwords.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Passwords exported!', 'success');
    };

    window.exportNotesJson = () => {
        if (!masterKey) { showToast('Unlock first!', 'error'); return; }
        const appData = getAppData().filter(i => i.type === 'note');
        const json = JSON.stringify(appData, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'notes.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Notes exported!', 'success');
    };


    // Event listeners for export/import buttons
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('export-passwords').addEventListener('click', exportPasswords);
        document.getElementById('import-passwords-file').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                importPasswords(e.target.files[0]);
                e.target.value = ''; // reset after import
            }
        });
    });

    async function exportPasswords() {
        if (!masterKey) { showToast('Unlock first!', 'error'); return; }
        const appData = getAppData();
        const items = appData.filter(i => i.type === 'password');
        if (!items.length) { showToast('No passwords to export!', 'error'); return; }

        const encoder = new TextEncoder();
        const data = encoder.encode(JSON.stringify(items));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, masterKey, data);
        const payload = { iv: buf2b64(iv.buffer), data: buf2b64(encrypted) };

        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'passwords-encrypted.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('Passwords exported (encrypted).', 'success');
    }

    async function importPasswords(file) {
        if (!masterKey) { showToast('Unlock first!', 'error'); return; }
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const payload = JSON.parse(e.target.result);
                const iv = b642buf(payload.iv);
                const encrypted = b642buf(payload.data);

                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: new Uint8Array(iv) },
                    masterKey,
                    encrypted
                );
                const decoder = new TextDecoder();
                const items = JSON.parse(decoder.decode(decrypted));

                const existing = getAppData();
                const merged = [...existing, ...items];
                saveAppData(merged);
                updateDisplay();
                showToast('Passwords imported successfully!', 'success');
            } catch (err) {
                console.error(err);
                showToast('Import failed (wrong key or file)', 'error');
            }
        };
        reader.readAsText(file);
    }

    async function exportNotes() {
        if (!masterKey) { showToast('Unlock first!', 'error'); return; }
        const appData = getAppData();
        const items = appData.filter(i => i.type === 'note');
        if (!items.length) { showToast('No notes to export!', 'error'); return; }

        const encoder = new TextEncoder();
        const data = encoder.encode(JSON.stringify(items));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, masterKey, data);
        const payload = { iv: buf2b64(iv.buffer), data: buf2b64(encrypted) };

        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'notes-encrypted.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('Notes exported (encrypted).', 'success');
    }

    async function importNotes(file) {
        if (!masterKey) { showToast('Unlock first!', 'error'); return; }
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const payload = JSON.parse(e.target.result);
                const iv = b642buf(payload.iv);
                const encrypted = b642buf(payload.data);

                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: new Uint8Array(iv) },
                    masterKey,
                    encrypted
                );
                const decoder = new TextDecoder();
                const items = JSON.parse(decoder.decode(decrypted));

                const existing = getAppData();
                const merged = [...existing, ...items];
                saveAppData(merged);
                updateDisplay();
                showToast('Notes imported successfully!', 'success');
            } catch (err) {
                console.error(err);
                showToast('Import failed (wrong key or file)', 'error');
            }
        };
        reader.readAsText(file);
    }

        document.getElementById('export-passwords').addEventListener('click', exportPasswords);
        document.getElementById('import-passwords-file').addEventListener('change', e => { if (e.target.files.length) { importPasswords(e.target.files[0]); e.target.value = ''; }});
        document.getElementById('export-notes').addEventListener('click', exportNotes);
        document.getElementById('import-notes-file').addEventListener('change', e => { if (e.target.files.length) { importNotes(e.target.files[0]); e.target.value = ''; }});
    window.addEventListener('load', () => {
        const savedTheme = localStorage.getItem(THEME_KEY); applyTheme(savedTheme === 'dark');
        const passwordSet = localStorage.getItem('master_password_set');
        if (passwordSet) { document.getElementById('set-password-screen').classList.add('hidden'); document.getElementById('auth-password-screen').classList.remove('hidden'); }
        document.getElementById('theme-toggle').addEventListener('click', () => { const currentTheme = localStorage.getItem(THEME_KEY); applyTheme(currentTheme !== 'dark'); });
    });
</script>
</body>
</html>
